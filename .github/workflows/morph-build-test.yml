name: Morph Build & Test on VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: [self-hosted, morph-vps]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        clean: true

    - name: Build Morph Compiler
      run: |
        cd ${{ github.workspace }}

        echo "Building morph with Go..."
        CGO_ENABLED=0 /tmp/go/bin/go build -o morph

        if [ -f "./morph" ]; then
          echo "✅ Morph compiler built successfully"
          ./morph --version || echo "Version: morph compiler"
          ls -lh morph
        else
          echo "❌ Build failed: morph binary not found"
          exit 1
        fi

    - name: Run Basic Tests
      run: |
        cd ${{ github.workspace }}

        echo "Running basic tests..."

        # Test 1: Compile a simple fox file
        if [ -f "n1/types.fox" ]; then
          echo "Test: Compiling n1/types.fox"
          timeout 30s ./morph build n1/types.fox || echo "⚠️  types.fox compilation timeout/failed"
        fi

        # Test 2: Check generated C files
        echo ""
        echo "Checking generated C files:"
        ls -lh *.c 2>/dev/null | head -5 || echo "No C files generated yet"

        # Test 3: Run compiled tests if available
        if [ -f "n1/types" ]; then
          echo ""
          echo "Test: Running n1/types"
          timeout 10s ./n1/types || echo "⚠️  n1/types execution failed"
        fi

        echo ""
        echo "✅ Basic tests completed"

    - name: Cleanup Build Artifacts
      if: always()
      run: |
        cd ${{ github.workspace }}

        echo "Cleaning up build artifacts..."

        # Remove generated C files
        rm -f *.c 2>/dev/null || true

        # Remove compiled binaries (keep morph compiler)
        find n1/ -type f -executable -delete 2>/dev/null || true

        # Keep only source files
        git clean -fdX

        echo "✅ Cleanup completed"
        echo ""
        echo "Remaining files:"
        ls -lh | head -10

    - name: Report Results
      if: always()
      run: |
        echo "================================================"
        echo "Build and Test Summary"
        echo "================================================"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Runner: vultr-vps-morph (self-hosted)"
        echo "Status: Check steps above for detailed results"
        echo "================================================"
