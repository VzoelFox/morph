name: Morph Build & Test on VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: [self-hosted, morph-vps]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        clean: true

    - name: Build Morph Compiler
      run: |
        cd ${{ github.workspace }}

        echo "Building morph with Go..."
        CGO_ENABLED=0 /tmp/go/bin/go build -o morph ./cmd/morph

        if [ -f "./morph" ]; then
          echo "✅ Morph compiler built successfully"
          ./morph --version || echo "Version: morph compiler"
          ls -lh morph
        else
          echo "❌ Build failed: morph binary not found"
          exit 1
        fi

    - name: Compile N1 Core Files
      run: |
        cd ${{ github.workspace }}

        echo "Compiling N1 core modules..."

        CORE_FILES=(
          "n1/token.fox"
          "n1/ast.fox"
          "n1/types.fox"
          "n1/lexer.fox"
          "n1/parser.fox"
          "n1/checker.fox"
        )

        FAILED=0
        for file in "${CORE_FILES[@]}"; do
          echo -n "  Compiling $file... "
          if timeout 60s ./morph build "$file" > /dev/null 2>&1; then
            echo "✅"
          else
            echo "❌ FAILED"
            ((FAILED++))
          fi
        done

        if [ $FAILED -gt 0 ]; then
          echo ""
          echo "❌ $FAILED core file(s) failed to compile"
          exit 1
        fi

        echo ""
        echo "✅ All N1 core files compiled successfully ($((${#CORE_FILES[@]} - FAILED))/${#CORE_FILES[@]})"

    - name: Run N1 Tests
      run: |
        cd ${{ github.workspace }}

        echo "Running N1 module tests..."

        # Test 1: types.fox has built-in test suite
        if [ -f "n1/types" ]; then
          echo "Test: Running types.fox test suite"
          if timeout 30s ./n1/types; then
            echo "✅ types.fox tests passed"
          else
            echo "⚠️  types.fox tests failed or timeout"
          fi
        fi

        echo ""
        echo "✅ N1 tests completed"

    - name: Cleanup Build Artifacts
      if: always()
      run: |
        cd ${{ github.workspace }}

        echo "Cleaning up build artifacts..."

        # Remove generated C files
        rm -f *.c 2>/dev/null || true

        # Remove compiled binaries (keep morph compiler)
        find n1/ -type f -executable -delete 2>/dev/null || true

        # Keep only source files
        git clean -fdX

        echo "✅ Cleanup completed"
        echo ""
        echo "Remaining files:"
        ls -lh | head -10

    - name: Report Results
      if: always()
      run: |
        echo "================================================"
        echo "Build and Test Summary"
        echo "================================================"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Runner: vultr-vps-morph (self-hosted)"
        echo "Status: Check steps above for detailed results"
        echo "================================================"
